<!--
@license
Copyright 2018 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../request-editor/request-editor.html">
<link rel="import" href="../response-view/response-view.html">
<link rel="import" href="../events-target-behavior/events-target-behavior.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">

<dom-module id="request-panel">
  <template>
    <style>
    :host {
      display: block;
      @apply --request-panel;
    }

    paper-progress {
      width: 100%;
      --paper-progress-active-color: var(--request-panel-progress-color, #00A2DF);

      @apply --request-panel-progress;
    }
    </style>
    <request-editor
      loading-request="[[loading]]"
      headers="{{editorRequest.headers}}"
      method="{{editorRequest.method}}"
      payload="{{editorRequest.payload}}"
      url="{{editorRequest.url}}"
      request-actions="{{editorRequest.requestActions}}"
      response-actions="{{editorRequest.responseActions}}"
      auth-settings="{{editorRequest.auth}}"
      query-model="{{editorRequest.queryModel}}"
      oauth2-redirect-uri="[[oauth2RedirectUri]]"
      xhr-extension="[[xhrExtension]]"
      events-target="[[eventsTarget]]">
      <slot name="request-context-menu" slot="request-context-menu"></slot>
    </request-editor>
    <template is="dom-if" if="[[loading]]">
      <paper-progress indeterminate></paper-progress>
    </template>
    <template is="dom-if" if="[[hasResponse]]">
      <response-view
        request="[[request]]"
        response="[[response]]"
        response-error="[[responseError]]"
        is-error="[[isErrorResponse]]"
        is-xhr="[[responseIsXhr]]"
        loading-time="{{loadingTime}}"
        redirects="[[redirects]]"
        redirect-timings="[[redirectsTiming]]"
        response-timings="[[timing]]"
        sent-http-message="[[sourceMessage]]"></response-view>
    </template>
  </template>
  <script>
  /**
   * A full request and response view for the Advanced REST client.
   *
   * ## Breaking changes in version 2
   *
   * - does not contain any logic responsible for making a request
   * - does not contain any logic responsible for request and response actions
   * - does not evaluate variables
   * - It only renders view for both request and response panels
   *
   * ## Styling
   *
   * `<request-panel>` provides the following custom properties and mixins for
   * styling:
   *
   * Custom property|Description|Default
   * ---------- | ------------------ | ------
   * `--request-panel`|Mixin applied to the element|`{}`
   * `--request-panel-progress-color` | Color of the progress bar | `#00A2DF`
   * `--request-panel-progress` | Mixin applied to the progress bar | `{}`
   *
   * @polymer
   * @customElement
   * @memberof UiElements
   * @appliesMixin ArcBehaviors.EventsTargetBehavior
   */
  class RequestPanel extends ArcBehaviors.EventsTargetBehavior(Polymer.Element) {
    static get is() { return 'request-panel'; }
    static get properties() {
      return {
        /**
         * A request object that is generated in request edtor.
         * It contains the following properties:
         * - url
         * - method
         * - headers
         * - payload
         * - queryModel
         * - pathModel
         */
        editorRequest: {
          type: Object,
          notify: true,
          value: function() {
            return {};
          }
        },
        /**
         * Computed value. If true then the request is loading.
         * This resets each time the request status changes.
         */
        loading: Boolean,
        /**
         * Created by the transport ARFC `request` object
         */
        request: Object,
        /**
         * Created by the transport ARC `response` object.
         */
        response: Object,
        /**
         * Computed value, true, when the response object is set.
         */
        hasResponse: {
          type: Boolean,
          computed: '_computeHasResponse(response)'
        },
        /**
         * If set then it renders an option in request context menu to
         * toggle to XHR request via the extension. This information is passed
         * to the request editor element.
         *
         * It's only relevant to ARC Chrome appeditorRequest.
         */
        xhrExtension: Boolean,
        /**
         * Redirect URL for the OAuth2 authorization.
         * If can be also set by dispatching `oauth2-redirect-url-changed`
         * with `value` property on the `detail` object.
         */
        oauth2RedirectUri: String,
        /**
         * A flag indincating request error.
         */
        isErrorResponse: Boolean,
        /**
         * True if the response is made by the Fetch / XHR api.
         */
        responseIsXhr: {
          type: Boolean,
          value: true
        },
        /**
         * An error object associated with the response when error.
         */
        responseError: Object,
        /**
         * Response full loading time. This information is received from the
         * transport library.
         */
        loadingTime: Number,
        /**
         * If the transport method is able to collect detailed information about request timings
         * then this value will be set. It's the `timings` property from the HAR 1.2 spec.
         */
        timing: Object,
        /**
         * If the transport method is able to collect detailed information about redirects timings
         * then this value will be set. It's a list of `timings` property from the HAR 1.2 spec.
         */
        redirectsTiming: Array,
        /**
         * It will be set if the transport method can generate information about redirections.
         */
        redirects: Array,
        /**
         * Http message sent to the server.
         *
         * This information should be available only in case of advanced HTTP transport.
         */
        sourceMessage: String,
        /**
         * ID of latest request.
         * It is received from the `api-request-editor` when `api-request`
         * event is dispatched. When `api-response` event is handled
         * the id is compared and if match it dispays the result.
         *
         * This system allows to use different request panels on single app
         * and don't mix the results.
         *
         * @type {String|Number}
         */
        lastRequestId: String
      };
    }

    /**
     * @constructor
     */
    constructor() {
      super();
      this._apiResponseHandler = this._apiResponseHandler.bind(this);
      this._sendRequestHandler = this._sendRequestHandler.bind(this);
      this._changeUrlHandler = this._changeUrlHandler.bind(this);
      this._abortHandler = this._abortHandler.bind(this);
      this._clearHandler = this._clearHandler.bind(this);
    }

    _attachListeners() {
      window.addEventListener('api-response', this._apiResponseHandler);
      this.addEventListener('api-request', this._sendRequestHandler);
      this.addEventListener('url-change-action', this._changeUrlHandler);
      this.addEventListener('abort-api-request', this._abortHandler);
      this.addEventListener('request-clear-state', this._clearHandler);
    }

    _detachListeners() {
      window.removeEventListener('api-response', this._apiResponseHandler);
      this.removeEventListener('api-request', this._sendRequestHandler);
      this.removeEventListener('url-change-action', this._changeUrlHandler);
      this.removeEventListener('abort-api-request', this._abortHandler);
      this.removeEventListener('request-clear-state', this._clearHandler);
    }
    /**
     * Computes if there is a reponse object.
     *
     * @param {Object} response ARC response objects
     * @return {Boolean}
     */
    _computeHasResponse(response) {
      return !!response;
    }
    /**
     * A handler for the API call.
     *
     * @param {CustomEvent} e `api-request` event
     */
    _sendRequestHandler(e) {
      this.lastRequestId = e.detail.id;
      this.loading = true;
    }
    /**
     * Handler for the `abort-api-request` custom event.
     * Clears loading state and `lastRequestId` property.
     */
    _abortHandler() {
      this.lastRequestId = undefined;
      this.loading = false;
    }
    /**
     * Handler for the `request-clear-state` custom event.
     * Clears loading state and `lastRequestId` property.
     */
    _clearHandler() {
      this.lastRequestId = undefined;
      this.loading = false;
    }

    /**
     * Handler for the `api-response` custom event. Sets values on the response
     * panel when response is ready.
     *
     * @param {CustomEvent} e
     */
    _apiResponseHandler(e) {
      if (this.lastRequestId !== e.detail.id) {
        return;
      }
      this.loading = false;
      this._propagateResponse(e.detail);
    }
    /**
     * Propagate `api-response` detail object.
     *
     * @param {Object} data Event's detail object
     */
    _propagateResponse(data) {
      this.isErrorResponse = data.isError;
      this.responseError = data.isError ? data.error : undefined;
      this.loadingTime = data.loadingTime;
      this.request = data.request;
      this.response = data.response;
      const isXhr = data.isXhr === false ? false : true;
      this.responseIsXhr = isXhr;
      this.redirects = isXhr ? undefined : data.redirects;
      this.redirectsTiming = isXhr ? undefined : data.redirectsTiming;
      this.timing = isXhr ? undefined : data.timing;
      this.sourceMessage = data.sentHttpMessage;
    }
    /**
     * Updates value of the request URL from `url-change-action`
     * custom event.
     */
    _changeUrlHandler(e) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      this.set('editorRequest.url', e.detail.url);
    }

    /**
     * Clears response panel.
     */
    clearResponse() {
      this.isErrorResponse = undefined;
      this.responseError = undefined;
      if (this.loadingTime) {
        this.loadingTime = undefined;
      }
      if (this.request) {
        this.request = undefined;
      }
      if (this.response) {
        this.response = undefined;
      }
      if (this.responseIsXhr !== undefined) {
        this.responseIsXhr = undefined;
      }
      if (this.redirects) {
        this.redirects = undefined;
      }
      if (this.redirectsTiming) {
        this.redirectsTiming = undefined;
      }
      if (this.timing) {
        this.timing = undefined;
      }
      if (this.sourceMessage) {
        this.sourceMessage = undefined;
      }
    }
  }
  window.customElements.define(RequestPanel.is, RequestPanel);
  </script>
</dom-module>
