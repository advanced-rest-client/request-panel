<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>

    <link rel="import" href="../request-logic.html">
    <link rel="import" href="../demo/demo-transport.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <request-logic></request-logic>
        <demo-transport></demo-transport>
      </template>
    </test-fixture>

    <script>
    /* global fixture, assert, sinon */
    const request = {
      url: 'https://domain.com/${test1}',
      headers: 'content-length: 0\nx-test: true\nx-var: ${test2}',
      method: 'POST',
      payload: '${test1}',
      responseActions: [{
        source: 'response.headers.status.${test4}',
        action: 'assign-variable',
        destination: 'myVar-${test3}'
      }],
      requestActions: {
        variables: [{
          enabled: true,
          value: 'test-value',
          variable: 'test-var'
        }, {
          enabled: true,
          variable: 'v2',
          value: '${test1}'
        }]
      }
    };
    suite('basic', function() {
      var element;
      setup(function() {
        element = fixture('basic')[0];
      });

      suite('reset()', function() {
        setup(function() {
          element.request = Object.assign({}, request);
          element.reset();
        });

        test('Resets _awaitingContinue', function() {
          assert.isFalse(element._awaitingContinue);
        });

        test('Resets _beforePromisesResolved', function() {
          assert.isTrue(element._beforePromisesResolved);
        });

        test('Resets _requestCopy', function() {
          assert.isUndefined(element._requestCopy);
        });

        test('Resets _cancelled', function() {
          assert.isFalse(element._awaitingContinue);
        });

        test('Resets beforeTimedOut', function() {
          assert.isFalse(element.beforeTimedOut);
        });
      });

      suite('_prepareEventRequest()', function() {
        var result;
        setup(function() {
          element.request = Object.assign({}, request);
          result = element._prepareEventRequest();
        });

        suiteTeardown(function() {
          element.request = {};
        });

        test('Copies request object properties', function() {
          assert.equal(result.url, request.url);
          assert.equal(result.headers, request.headers);
          assert.equal(result.method, request.method);
        });

        test('Generated object is a copy', function() {
          result.url = 'test';
          assert.notEqual(result.url, request.url);
        });

        test('Adds promises array', function() {
          assert.typeOf(result.promises, 'array');
        });

        test('Removes payload for GET', function() {
          element.request.payload = 'test';
          element.request.method = 'GET';
          result = element._prepareEventRequest();
          assert.isUndefined(result.payload);
        });

        test('Removes payload for HEAD', function() {
          element.request.payload = 'test';
          element.request.method = 'HEAD';
          result = element._prepareEventRequest();
          assert.isUndefined(result.payload);
        });

        test('Do not removes payload for POST', function() {
          element.request.payload = 'test';
          element.request.method = 'POST';
          result = element._prepareEventRequest();
          assert.equal(result.payload, 'test');
        });
      });

      suite('_computeHandlersTimeout()', function() {

        setup(function() {
          element.request = Object.assign({}, request);
        });

        test('Uses default timeout for lack of arguments', function() {
          var result = element._computeHandlersTimeout();
          assert.equal(result, element.handlersTimeout);
        });

        test('Returns highest time from the array of objects', function() {
          var args = [{
            'timeout': 2500
          }, {
            'timeout': 3500
          }, {
            'timeout': 2700
          }];
          var result = element._computeHandlersTimeout(args);
          assert.equal(result, args[1].timeout);
        });

        test('Returns default time for lower timeouts in argument object', function() {
          var args = [{
            'timeout': 100
          }, {
            'timeout': 200
          }, {
            'timeout': 300
          }];
          var result = element._computeHandlersTimeout(args);
          assert.equal(result, element.handlersTimeout);
        });

        test('Returns -1 when handlersTimeout is removed', function() {
          element.handlersTimeout = 0;
          var result = element._computeHandlersTimeout();
          assert.equal(result, -1);
        });

        test('Returns -1 when any of timeouts in array is 0', function() {
          assert.isAbove(element.handlersTimeout, 0);
          var args = [{
            'timeout': 100
          }, {
            'timeout': 0
          }, {
            'timeout': 300
          }];
          var result = element._computeHandlersTimeout(args);
          assert.equal(result, -1);
        });
      });
    });

    suite('_clearBeforeRequestTimeout', function() {
      var element;
      setup(function() {
        element = fixture('basic')[0];
        element.request = Object.assign({}, request);
      });

      test('Clears the variable', function() {
        element._currentTimeout = 'test';
        element._clearBeforeRequestTimeout();
        assert.isUndefined(element._currentTimeout);
      });

      test('Do nothing when variable is empty', function() {
        element._clearBeforeRequestTimeout();
        // Basically it doesn't throws an error.
        assert.isUndefined(element._currentTimeout);
      });

      test('Clears existing timeout', function(done) {
        var errored = false;
        element._currentTimeout = window.setTimeout(function() {
          errored = true;
          done(new Error('Do not clears the timeout.'));
        }, 10);
        element._clearBeforeRequestTimeout();
        window.setTimeout(function() {
          done();
        }, 15);
      });
    });

    suite('_prepareTransportObject()', function() {
      var element;
      const orig = {
        a: 'v1',
        b: 'v2',
        c: 'v3',
        id: 1
      };
      var result;
      setup(function() {
        element = fixture('basic')[0];
        result = element._prepareTransportObject(orig);
      });

      test('Creates copy of the object', function() {
        assert.deepEqual(result, orig);
      });

      test('Values are immutable', function() {
        result.a = 'a1';
        result.b = 'a2';
        result.c = 'a3';
        assert.equal(result.a, orig.a);
        assert.equal(result.b, orig.b);
        assert.equal(result.c, orig.c);
        assert.notEqual(result.a, 'a1');
        assert.notEqual(result.b, 'a2');
        assert.notEqual(result.c, 'a3');
      });
    });

    suite('Pre request variables set', function() {
      var result;
      var element;
      setup(function() {
        element = fixture('basic')[0];
      });
      const contextFactory = function(e) {
        e.preventDefault();
        e.detail.value = [{
          variable: 'test1',
          value: 'value1',
          enabled: true
        }, {
          variable: 'test2',
          value: 'value2 ${test1}',
          enabled: true
        }, {
          variable: 'test3',
          value: 'value3 ${test4}',
          enabled: true
        }, {
          variable: 'test4',
          value: 'value4',
          enabled: true
        }, {
          variable: 'test5',
          value: 'value5',
          enabled: false
        }];
      };
      suiteSetup(function() {
        window.addEventListener('variable-list', contextFactory);
      });
      suiteTeardown(function() {
        window.removeEventListener('variable-list', contextFactory);
      });

      suite('_preparePreRequestVariables()', function() {

        test('Returns Promise', function() {
          result = element._preparePreRequestVariables(request);
          assert.typeOf(result.then, 'function');
        });

        test('Evaluates variables', function() {
          return element._preparePreRequestVariables(request)
          .then(function(result) {
            assert.equal(result.v2, 'value1');
          });
        });

        test('Contains list of variables', function() {
          return element._preparePreRequestVariables(request)
          .then(function(result) {
            assert.equal(result['test-var'], 'test-value');
            assert.equal(result.v2, 'value1');
          });
        });

        test('Contains two items', function() {
          return element._preparePreRequestVariables(request)
          .then(function(result) {
            assert.lengthOf(Object.keys(result), 2);
          });
        });

        test('Returns undefined when no actions', function() {
          return element._preparePreRequestVariables({})
          .then(function(result) {
            assert.isUndefined(result);
          });
        });

        test('Returns undefined when no variables in actions', function() {
          return element._preparePreRequestVariables({
            requestActions: {}
          })
          .then(function(result) {
            assert.isUndefined(result);
          });
        });
      });

      suite('_notifyVariablesChange()', function() {
        const vars = {
          v1: 't1',
          v2: '${test1}'
        };
        setup(function() {
          element = fixture('basic')[0];
        });

        test('Fires event when variable to be set', function() {
          var spy = sinon.spy();
          element.addEventListener('variable-update-action', spy);
          element._notifyVariablesChange(vars);
          assert.equal(spy.callCount, 2);
        });

        test('Event detail contains valid properties', function() {
          var eventData;
          element.addEventListener('variable-update-action', function clb(e) {
            element.removeEventListener('variable-update-action', clb);
            eventData = e.detail;
          });
          element._notifyVariablesChange(vars);
          assert.equal(eventData.variable, 'v1');
          assert.equal(eventData.value, 't1');
        });

        test('Does not fire events for empty object', function() {
          var spy = sinon.spy();
          element.addEventListener('variable-update-action', spy);
          element._notifyVariablesChange({});
          assert.isFalse(spy.called);
        });

        test('Does not fire events for missing object', function() {
          var spy = sinon.spy();
          element.addEventListener('variable-update-action', spy);
          element._notifyVariablesChange();
          assert.isFalse(spy.called);
        });
      });

      suite('_beforeProcessVariables()', function() {
        var result;
        setup(function(done) {
          element = fixture('basic')[0];
          element._beforeRequest = function(data) {
            result = data;
            done();
          };
          element._beforeProcessVariables(request);
        });
        test('Processes all variables', function() {
          assert.equal(result.url, 'https://domain.com/value1');
          assert.equal(result.headers, 'content-length: 0\nx-test: true\nx-var: value2 value1');
          assert.equal(result.payload, 'value1');
        });
      });
    });
    </script>

  </body>
</html>
